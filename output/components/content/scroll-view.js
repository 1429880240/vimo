"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScrollView=void 0;var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_util=require("../../util/util"),SCROLL_END_DEBOUNCE_MS=80,FRAME_MS=1e3/60,EVENT_OPTS={passive:!0},ScrollView=exports.ScrollView=function(){function e(){(0,_classCallCheck3.default)(this,e),this.isScrolling=!1,this.initialized=!1,this.scrollStart=function(e){},this.scroll=function(e){},this.scrollEnd=function(e){},this.transform=window.VM&&window.VM.platform&&window.VM.platform.css?window.VM.platform.css.transform:"webkitTransform",this._el=null,this._lsn=null,this._endTmr=null,this.ev={timeStamp:0,scrollTop:0,scrollLeft:0,scrollHeight:0,scrollWidth:0,contentHeight:0,contentWidth:0,contentTop:0,contentBottom:0,startY:0,startX:0,deltaY:0,deltaX:0,velocityY:0,velocityX:0,directionY:"down",directionX:null,contentElement:null,fixedElement:null,scrollElement:null,headerElement:null,footerElement:null}}return(0,_createClass3.default)(e,[{key:"init",value:function(e){this.initialized||(this.initialized=!0,console.assert(e,"scroll-view, element can not be null"),this._el=e,this.enableNativeScrolling())}},{key:"enableNativeScrolling",value:function(){function e(e){function o(){l.isScrolling=!1,t.velocityY=t.velocityX=0,l.scrollEnd(t),l._endTmr=null}if(t.timeStamp=e.timeStamp,t.scrollTop=l.getTop(),t.scrollLeft=l.getLeft(),l.isScrolling||(l.isScrolling=!0,t.startY=t.scrollTop,t.startX=t.scrollLeft,t.velocityY=t.velocityX=0,t.deltaY=t.deltaX=0,i.length=0,l.scrollStart(t)),i.push(t.scrollTop,t.scrollLeft,t.timeStamp),i.length>3){t.deltaY=t.scrollTop-t.startY,t.deltaX=t.scrollLeft-t.startX;for(var r=i.length-1,s=r,n=t.timeStamp-100,c=r;c>0&&i[c]>n;c-=3)s=c;if(s!==r){var a=i[r]-i[s],u=i[s-2]-i[r-2],h=i[s-1]-i[r-1];t.velocityY=u/a*FRAME_MS,t.velocityX=h/a*FRAME_MS,t.directionY=u>0?"up":"down",t.directionX=h>0?"left":"right"}}l.scroll(t),window.clearTimeout(l._endTmr),l._endTmr=window.setTimeout(o,SCROLL_END_DEBOUNCE_MS)}if(this._el){var l=this,t=l.ev,i=[];l._lsn&&l._lsn(),l._lsn=(0,_util.registerListener)(l._el,"scroll",e,EVENT_OPTS)}}},{key:"getTop",value:function(){return this._el.scrollTop}},{key:"getLeft",value:function(){return this._el.scrollLeft}},{key:"setTop",value:function(e){this._el.scrollTop=e}},{key:"setLeft",value:function(e){this._el.scrollLeft=e}},{key:"scrollTo",value:function(){function e(){if(d++,!s._el||m||d>u)return s.isScrolling=!1,n.style[h]="",void o();_=(new Date).getTime();var r=Math.min(1,(_-f)/i),v=--r*r*r+1;c!==t&&s.setTop(v*(t-c)+c),a!==l&&s.setLeft(Math.floor(v*(l-a)+a)),v<1?(0,_util.nativeRaf)(e):(m=!0,s.isScrolling=!1,o())}var l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments[2],o=arguments[3],r=void 0;void 0===o&&(r=new _promise2.default(function(e){o=e}));var s=this,n=s._el;if(!n)return o(),r;if(i<32)return s.setTop(t),s.setLeft(l),o(),r;var c=n.scrollTop,a=n.scrollLeft,u=i/16+100,h=s.transform,f=void 0,_=void 0,d=0,m=!1;return s.isScrolling=!0,f=(new Date).getTime(),(0,_util.nativeRaf)(e),r}},{key:"scrollToTop",value:function(e){return this.scrollTo(0,0,e)}},{key:"scrollToBottom",value:function(e){var l=0;return this._el&&(l=this._el.scrollHeight-this._el.clientHeight),this.scrollTo(0,l,e)}},{key:"stop",value:function(){this.isScrolling=!1}},{key:"destroy",value:function(){this.stop(),this._endTmr&&window.clearTimeout(self._endTmr),this._lsn&&this._lsn(),this.scrollStart&&(this.scrollStart=null),this.scroll&&(this.scrollStart=null),this.scrollEnd&&(this.scrollStart=null);var e=this.ev;e.contentElement=e.fixedElement=e.scrollElement=e.headerElement=null,this._lsn=this._el=this.ev=e=null}}]),e}();