"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function getCss(t){var e,i={transform:null,transition:null,transitionDuration:null,transitionDelay:null,transitionTimingFn:null,transitionStart:null,transitionEnd:null,transformOrigin:null,animationDelay:null},n=["webkitTransform","-webkit-transform","webkit-transform","transform"];for(e=0;e<n.length;e++)if(void 0!==t.style[n[e]]){i.transform=n[e];break}for(n=["webkitTransition","transition"],e=0;e<n.length;e++)if(void 0!==t.style[n[e]]){i.transition=n[e];break}var r=i.transition.indexOf("webkit")>-1;return i.transitionDuration=(r?"-webkit-":"")+"transition-duration",i.transitionTimingFn=(r?"-webkit-":"")+"transition-timing-function",i.transitionDelay=(r?"-webkit-":"")+"transition-delay",i.transitionEnd=(r?"webkitTransitionEnd ":"")+"transitionend",i.transformOrigin=(r?"-webkit-":"")+"transform-origin",i.animationDelay=r?"webkitAnimationDelay":"animationDelay",i}function insertSuperset(t,e){var i=e.superset();if(i){var n=new PlatformNode(t,i);n.parent=e.parent,n.child=e,n.parent&&(n.parent.child=n),e.parent=n}}function ready(t){function e(){document.removeEventListener("DOMContentLoaded",e,!1),window.removeEventListener("load",e,!1),t()}var i=null;return t||(i=new _promise2.default(function(e){t=e})),"complete"===document.readyState||"interactive"===document.readyState?t():(document.addEventListener("DOMContentLoaded",e,!1),window.addEventListener("load",e,!1)),i}function removeArrayItem(t,e){var i=t.indexOf(e);return!!~i&&!!t.splice(i,1)}function setupPlatform(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(window.VM&&window.VM.platform)return window.VM.platform;var e=new Platform,i=_platformDefaultConfigs.PLATFORM_DEFAULT_CONFIGS;for(var n in t)if(i[n]){var r=t[n],s=i[n];for(var a in r){var o={};o=(0,_util.defaults)(r[a],s[a]),s[a]=o}}else i[n]=t[n];return e.setDefault("mobile"),e.setPlatformConfigs(i),e.setQueryParams(new QueryParams),!e.navigatorPlatform()&&e.setNavigatorPlatform(window.navigator.platform),!e.userAgent()&&e.setUserAgent(window.navigator.userAgent),!e.lang()&&e.setLang("zh-cn",!0),!e.dir()&&e.setDir("ltr",!0),e.setCssProps(document.documentElement),e.init(),e.prepareReady(),window.VM=window.VM||{},window.VM.platform=e,e}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);exports.setupPlatform=setupPlatform;var _platformDefaultConfigs=require("./platform-default-configs"),_util=require("../util/util"),Platform=function(){function t(){var e=this;(0,_classCallCheck3.default)(this,t),this._readyPromise=new _promise2.default(function(t){e._readyResolve=t}),this._versions={},this._dir,this._lang,this._qp,this._bPlt,this._ua,this._readyPromise,this._readyResolve,this._resizeTm,this._onResizes=[],this._bbActions=[],this._default,this._platforms=[],this._registry,this._pW=0,this._pH=0,this._lW=0,this._lH=0,this._isPortrait=null,this._nt=null,this.css={transform:null,transition:null,transitionDuration:null,transitionDelay:null,transitionTimingFn:null,transitionStart:null,transitionEnd:null,transformOrigin:null,animationDelay:null}}return(0,_createClass3.default)(t,[{key:"setCssProps",value:function(t){this.css=getCss(t)}},{key:"is",value:function(t){return this._platforms.indexOf(t)>-1}},{key:"platforms",value:function(){return this._platforms}},{key:"versions",value:function(){return this._versions}},{key:"version",value:function(){for(var t in this._versions)if(this._versions[t])return this._versions[t];return{}}},{key:"ready",value:function(){return this._readyPromise}},{key:"triggerReady",value:function(t){this._readyResolve(t)}},{key:"prepareReady",value:function(){this.triggerReady("No Platform Initialization Process!")}},{key:"setDir",value:function(t,e){this._dir=(t||"").toLowerCase(),e&&document.documentElement.setAttribute("dir",t)}},{key:"dir",value:function(){return this._dir}},{key:"isRTL",value:function(){return"rtl"===this._dir}},{key:"setLang",value:function(t,e){this._lang=t,e&&document.documentElement.setAttribute("lang",t)}},{key:"lang",value:function(){return this._lang}},{key:"setNetType",value:function(t){this._nt=t}},{key:"netType",value:function(){return this._nt}},{key:"exitApp",value:function(){}},{key:"backButton",value:function(){}},{key:"pause",value:function(){}},{key:"resume",value:function(){}},{key:"registerBackButtonAction",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n={fn:t,priority:i};return this._bbActions.push(n),function(){removeArrayItem(e._bbActions,n)}}},{key:"runBackButtonAction",value:function(){var t=null;this._bbActions.forEach(function(e){(!t||e.priority>=t.priority)&&(t=e)}),t&&t.fn&&t.fn()}},{key:"setUserAgent",value:function(t){this._ua=t}},{key:"setQueryParams",value:function(t){this._qp=t}},{key:"getQueryParam",value:function(t){return this._qp.get(t)}},{key:"userAgent",value:function(){return this._ua||""}},{key:"setNavigatorPlatform",value:function(t){this._bPlt=t}},{key:"navigatorPlatform",value:function(){return this._bPlt||""}},{key:"width",value:function(){return this._calcDim(),this._isPortrait?this._pW:this._lW}},{key:"height",value:function(){return this._calcDim(),this._isPortrait?this._pH:this._lH}},{key:"isPortrait",value:function(){return this._calcDim(),this._isPortrait}},{key:"isLandscape",value:function(){return!this.isPortrait()}},{key:"_calcDim",value:function(){var t=window;(null===this._isPortrait||this._isPortrait===!1&&this.win.innerWidth<this.win.innerHeight)&&t.screen.width>0&&t.screen.height>0&&(t.innerWidth<t.innerHeight?(this._pW<=t.innerWidth&&(this._isPortrait=!0,this._pW=t.innerWidth),this._pH<=t.innerHeight&&(this._isPortrait=!0,this._pH=t.innerHeight)):(this._lW>t.innerWidth&&(this._isPortrait=!0),this._lW<=t.innerWidth&&(this._isPortrait=!1,this._lW=t.innerWidth),this._lH<=t.innerHeight&&(this._isPortrait=!1,this._lH=t.innerHeight)))}},{key:"windowResize",value:function(){var t=this;clearTimeout(this._resizeTm),this._resizeTm=setTimeout(function(){t._isPortrait=null;for(var e=0;e<t._onResizes.length;e++)try{!!t._onResizes[e]&&"function"==typeof t._onResizes[e]&&t._onResizes[e]()}catch(t){console.error(t)}},200)}},{key:"onResize",value:function(t){var e=this;return e._onResizes.push(t),function(){removeArrayItem(e._onResizes,t)}}},{key:"setPlatformConfigs",value:function(t){this._registry=t||{}}},{key:"getPlatformConfig",value:function(t){return this._registry[t]||{}}},{key:"registry",value:function(){return this._registry}},{key:"setDefault",value:function(t){this._default=t}},{key:"testQuery",value:function(t,e){return t.toLowerCase().split(";").indexOf(e)>-1}},{key:"testNavigatorPlatform",value:function(t){return new RegExp(t,"i").test(this._bPlt)}},{key:"matchUserAgentVersion",value:function(t){if(this._ua&&t){var e=this._ua.match(t);if(e)return{major:e[1],minor:e[2],third:e[3]}}}},{key:"testUserAgent",value:function(t){return!!this._ua&&this._ua.indexOf(t)>=0}},{key:"isPlatformMatch",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=this._qp.get("platform");if(n)return this.testQuery(n,t);e=e||[t];for(var r=this._ua.toLowerCase(),s=0;s<e.length;s++)if(r.indexOf(e[s])>-1){for(var a=0;a<i.length;a++)if(r.indexOf(i[a])>-1)return!1;return!0}return!1}},{key:"init",value:function(){this._calcDim(),this._platforms=[];var t=void 0,e=void 0,i=void 0;for(var n in this._registry)(i=this.matchPlatform(n))&&(i.isEngine?e=i:(!t||i.depth>t.depth)&&(t=i));if(t||(t=new PlatformNode(this._registry,this._default)),t){e&&(e.child=t,t.parent=e,t=e);for(var r=t;r;)insertSuperset(this._registry,r),r=r.child;for(r=t.parent;r;)t=r,r=r.parent;for(r=t;r;)r.initialize(this),this._platforms.push(r.name),this._versions[r.name]=r.version(this),r=r.child}}},{key:"matchPlatform",value:function(t){var e=new PlatformNode(this._registry,t),i=e.getRoot(this);if(i){i.depth=0;for(var n=i.child;n;)i.depth++,n=n.child}return i}}]),t}(),PlatformNode=function(){function t(e,i){(0,_classCallCheck3.default)(this,t),this.registry=e,this.c=e[i],this.name=i,this.isEngine=this.c&&this.c.isEngine,this.parent,this.child,this.name,this.isEngine,this.depth}return(0,_createClass3.default)(t,[{key:"settings",value:function(){return this.c.settings||{}}},{key:"superset",value:function(){return this.c.superset}},{key:"isMatch",value:function(t){return this.c.isMatch&&this.c.isMatch(t)||!1}},{key:"initialize",value:function(t){this.c.initialize&&this.c.initialize(t)}},{key:"version",value:function(t){if(this.c.versionParser){var e=this.c.versionParser(t);if(e){var i=e.major+"."+e.minor+(e.third?"."+e.third:"");return{str:i,num:parseFloat(i),major:parseInt(e.major,10),minor:parseInt(e.minor,10),third:parseInt(e.third,10)}}}}},{key:"getRoot",value:function(e){if(this.isMatch(e)){var i=this.getSubsetParents(this.name);if(!i.length)return this;for(var n=null,r=null,s=0;s<i.length;s++)if(n=new t(this.registry,i[s]),n.child=this,r=n.getRoot(e))return this.parent=n,r}return null}},{key:"getSubsetParents",value:function(t){var e=[],i=null;for(var n in this.registry)i=this.registry[n],i.subsets&&i.subsets.indexOf(t)>-1&&e.push(n);return e}}]),t}(),QueryParams=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href;(0,_classCallCheck3.default)(this,t),this.data={},this.parseUrl(e)}return(0,_createClass3.default)(t,[{key:"get",value:function(t){return this.data[t.toLowerCase()]}},{key:"parseUrl",value:function(t){if(t){var e=t.indexOf("?");if(e>-1)for(var i=t.slice(e+1).split("&"),n=0;n<i.length;n++)if(i[n].indexOf("=")>0){var r=i[n].split("=");r.length>1&&(this.data[r[0].toLowerCase()]=r[1].split("#")[0])}}return this.data}}]),t}();