"use strict";function _classCallCheck(l,t){if(!(l instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScrollView=void 0;var _createClass=function(){function l(l,t){for(var e=0;e<t.length;e++){var s=t[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(l,s.key,s)}}return function(t,e,s){return e&&l(t.prototype,e),s&&l(t,s),t}}(),_util=require("../../util/util"),SCROLL_END_DEBOUNCE_MS=80,FRAME_MS=1e3/60,EVENT_OPTS={passive:!0},ScrollView=exports.ScrollView=function(){function l(){_classCallCheck(this,l),this.isScrolling=!1,this.initialized=!1,this.scrollStart=function(l){},this.scroll=function(l){},this.scrollEnd=function(l){},this.transform=window.VM.platform.css.transform,this._el=null,this._cel=null,this._js=!1,this._t=0,this._l=0,this._lsn=null,this._endTmr=null,this._jsScrollInstance=null,this._scrollToEndTimer=null,this.ev={isJsScroll:!1,timeStamp:0,scrollTop:0,scrollLeft:0,scrollHeight:0,scrollWidth:0,contentHeight:0,contentWidth:0,contentTop:0,contentBottom:0,startY:0,startX:0,deltaY:0,deltaX:0,velocityY:0,velocityX:0,directionY:"down",directionX:null,contentElement:null,fixedElement:null,scrollElement:null,headerElement:null,footerElement:null}}return _createClass(l,[{key:"init",value:function(l){this.initialized||(this.initialized=!0,console.assert(l,"scroll-view, element can not be null"),this._el=l,this._cel=l.parentElement,this._js?this.enableBScroll():this.enableNativeScrolling())}},{key:"enableNativeScrolling",value:function(){function l(l){function i(){t.isScrolling=!1,e.velocityY=e.velocityX=0,t.scrollEnd(e),t._endTmr=null}if(e.timeStamp=l.timeStamp,e.scrollTop=t.getTop(),e.scrollLeft=t.getLeft(),t.isScrolling||(t.isScrolling=!0,e.startY=e.scrollTop,e.startX=e.scrollLeft,e.velocityY=e.velocityX=0,e.deltaY=e.deltaX=0,s.length=0,t.scrollStart(e)),s.push(e.scrollTop,e.scrollLeft,e.timeStamp),s.length>3){e.deltaY=e.scrollTop-e.startY,e.deltaX=e.scrollLeft-e.startX;for(var o=s.length-1,n=o,r=e.timeStamp-100,c=o;c>0&&s[c]>r;c-=3)n=c;if(n!==o){var a=s[o]-s[n],h=s[n-2]-s[o-2],u=s[n-1]-s[o-1];e.velocityY=h/a*FRAME_MS,e.velocityX=u/a*FRAME_MS,e.directionY=h>0?"up":"down",e.directionX=u>0?"left":"right"}}t.scroll(e),window.clearTimeout(t._endTmr),t._endTmr=window.setTimeout(i,SCROLL_END_DEBOUNCE_MS)}if(this._el){var t=this,e=t.ev,s=[];t._js=!1,e.isJsScroll=!1,console.debug("ScrollView, enableNativeScrolling"),t._lsn&&t._lsn(),t._lsn=(0,_util.registerListener)(t._el,"scroll",l,EVENT_OPTS)}}},{key:"enableBScroll",value:function(){console.debug("ScrollView, enableBScroll");var l=this._el.parentElement,t=require("better-scroll/build/bscroll.js");this._js=!0,this._el.parentElement.classList.add("js-scroll");var e=window.VM.config.get("jsScrollOptions",{});this._jsScrollInstance=new t(l,e)}},{key:"enableIScroll",value:function(){console.debug("ScrollView, enableIScroll");var l=this._el.parentElement,t=this,e=t.ev,s=[],i=require("iscroll/build/iscroll-probe");t._js=!0,e.isJsScroll=!0,t._el.parentElement.classList.add("js-scroll");var o=window.VM.config.get("jsScrollOptions",{});t._jsScrollInstance=new i(l,o),t._jsScrollInstance.on("scrollStart",function(){t.isScrolling=!0,e.startY=-1*t._jsScrollInstance.y>>0,e.startX=-1*t._jsScrollInstance.x>>0,e.velocityY=e.velocityX=0,e.deltaY=e.deltaX=0,s.length=0,t.scrollStart(e)}),t._jsScrollInstance.on("scroll",function(){if(e.timeStamp=(new Date).getTime(),e.scrollTop=-1*t._jsScrollInstance.y>>0,e.scrollLeft=-1*t._jsScrollInstance.x>>0,s.push(e.scrollTop,e.scrollLeft,e.timeStamp),s.length>3){e.deltaY=e.scrollTop-e.startY,e.deltaX=e.scrollLeft-e.startX;for(var l=s.length-1,i=l,o=e.timeStamp-100,n=l;n>0&&s[n]>o;n-=3)i=n;if(i!==l){var r=s[l]-s[i],c=s[i-2]-s[l-2],a=s[i-1]-s[l-1];if(e.velocityY=c/r*FRAME_MS,e.velocityX=a/r*FRAME_MS,t._jsScrollInstance.options.scrollY){var h=t._jsScrollInstance.directionY;e.directionY=0===h?c>0?"up":"down":h>0?"down":"up"}else{var u=t._jsScrollInstance.directionX;e.directionX=0===u?a>0?"left":"right":u>0?"right":"left"}}}t.scroll(e)}),t._jsScrollInstance.on("scrollEnd",function(){t.isScrolling=!1,e.velocityY=e.velocityX=0,t.scrollEnd(e)})}},{key:"getHeight",value:function(){return this._js?this._jsScrollInstance.scrollerHeight:this._el&&this._el.scrollHeight}},{key:"getWidth",value:function(){return this._js?this._jsScrollInstance.scrollerWidth:this._el&&this._el.scrollWidth}},{key:"getTop",value:function(){return this._js?-1*this._jsScrollInstance.y:this._el&&this._el.scrollTop}},{key:"getLeft",value:function(){return this._js?-1*this._jsScrollInstance.x:this._el&&this._el.scrollLeft}},{key:"setTop",value:function(l){this._el.scrollTop=l}},{key:"setLeft",value:function(l){this._el.scrollLeft=l}},{key:"stop",value:function(){this.isScrolling=!1}},{key:"destroy",value:function(){this.stop(),this._js?(this._jsScrollInstance.destroy(),this._jsScrollInstance=null):(this._endTmr&&window.clearTimeout(this._endTmr),this._lsn&&this._lsn(),this._lsn=null);var l=this.ev;l.contentElement=l.fixedElement=l.scrollElement=l.headerElement=null,this._el=this.ev=l=null,this.scrollStart&&(this.scrollStart=null),this.scroll&&(this.scrollStart=null),this.scrollEnd&&(this.scrollStart=null)}},{key:"scrollTo",value:function(){var l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300,i=arguments[3],o=this._el,n=void 0;if(void 0===i&&(n=new Promise(function(l){i=l})),!o)return console.assert(o,"The method of scrollTo() need scrollElement!"),i(),n;if(this._js)this._jsScrollInstance.scrollTo(l,-1*t,s),this._scrollToEndTimer&&window.clearTimeout(this._scrollToEndTimer),this._scrollToEndTimer=window.setTimeout(function(){i(),e._scrollToEndTimer=null},s);else{if(s<32)return this.setTop(t),this.setLeft(l),i(),n;var r=o.scrollTop,c=o.scrollLeft,a=s/16+100,h=this.transform,u=void 0,_=void 0,d=0,f=!1,v=function n(){if(d++,!e._el||f||d>a)return e.isScrolling=!1,o.style[h]="",void i();_=(new Date).getTime();var v=Math.min(1,(_-u)/s),S=--v*v*v+1;r!==t&&e.setTop(S*(t-r)+r),c!==l&&e.setLeft(Math.floor(S*(l-c)+c)),S<1?window.requestAnimationFrame(n):(f=!0,e.isScrolling=!1,i())};this.isScrolling=!0,u=(new Date).getTime(),window.requestAnimationFrame(v)}return n}},{key:"scrollToTop",value:function(){var l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300;return this.scrollTo(0,0,l)}},{key:"scrollToBottom",value:function(){var l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=0;return this._el&&(t=this._js?this.ev.scrollHeight-this._cel.clientHeight:this._el.scrollHeight-this._el.clientHeight),this.scrollTo(0,t,l)}},{key:"scrollBy",value:function(){var l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300,s=arguments[3];return t+=this.getTop(),l+=this.getLeft(),this.scrollTo(l,t,e,s)}},{key:"scrollToElement",value:function(l){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments[4];if(!l)return console.assert(l,"The method scrollToElement() need element!"),!1;var o=0,n=l.offsetTop;return(0,_util.isPresent)(e)&&((0,_util.isNumber)(e)&&0!==e&&(o=l.offsetLeft+e),(0,_util.isBoolean)(e)&&e&&(o=l.offsetLeft+(this.ev.contentWidth-l.offsetWidth)/2)),(0,_util.isPresent)(s)&&((0,_util.isNumber)(s)&&(n-=s),(0,_util.isBoolean)(s)&&s&&(n-=(this.ev.contentHeight-l.offsetHeight)/2)),this.scrollTo(o,n,t,i)}}]),l}();