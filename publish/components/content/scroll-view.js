"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScrollView=void 0;var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_util=require("../../util/util"),SCROLL_END_DEBOUNCE_MS=80,FRAME_MS=1e3/60,EVENT_OPTS={passive:!0},ScrollView=exports.ScrollView=function(){function e(){(0,_classCallCheck3.default)(this,e),this.isScrolling=!1,this.initialized=!1,this.scrollStart=function(e){},this.scroll=function(e){},this.scrollEnd=function(e){},this.transform=window.VM.platform.css.transform,this._el=null,this._cel=null,this._js=!1,this._lsn=null,this._endTmr=null,this._jsScrollInstance={},this._scrollToEndTimer=null,this.ev={isJsScroll:!1,timeStamp:0,scrollTop:0,scrollLeft:0,scrollHeight:0,scrollWidth:0,contentHeight:0,contentWidth:0,contentTop:0,contentBottom:0,startY:0,startX:0,deltaY:0,deltaX:0,velocityY:0,velocityX:0,directionY:"down",directionX:null,contentElement:null,fixedElement:null,scrollElement:null,headerElement:null,footerElement:null}}return(0,_createClass3.default)(e,[{key:"init",value:function(e){this.initialized||(this.initialized=!0,console.assert(e,"scroll-view, element can not be null"),this._el=e,this._cel=e.parentElement,this._js?this.enableBScroll():this.enableNativeScrolling())}},{key:"enableNativeScrolling",value:function(){function e(e){function s(){t.isScrolling=!1,l.velocityY=l.velocityX=0,t.scrollEnd(l),t._endTmr=null}if(l.timeStamp=e.timeStamp,l.scrollTop=t.getTop(),l.scrollLeft=t.getLeft(),t.isScrolling||(t.isScrolling=!0,l.startY=l.scrollTop,l.startX=l.scrollLeft,l.velocityY=l.velocityX=0,l.deltaY=l.deltaX=0,i.length=0,t.scrollStart(l)),i.push(l.scrollTop,l.scrollLeft,l.timeStamp),i.length>3){l.deltaY=l.scrollTop-l.startY,l.deltaX=l.scrollLeft-l.startX;for(var o=i.length-1,n=o,r=l.timeStamp-100,c=o;c>0&&i[c]>r;c-=3)n=c;if(n!==o){var a=i[o]-i[n],h=i[n-2]-i[o-2],u=i[n-1]-i[o-1];l.velocityY=h/a*FRAME_MS,l.velocityX=u/a*FRAME_MS,l.directionY=h>0?"up":"down",l.directionX=u>0?"left":"right"}}t.scroll(l),window.clearTimeout(t._endTmr),t._endTmr=window.setTimeout(s,SCROLL_END_DEBOUNCE_MS)}if(this._el){var t=this,l=t.ev,i=[];t._js=!1,l.isJsScroll=!1,console.debug("ScrollView, enableNativeScrolling"),t._lsn&&t._lsn(),t._lsn=(0,_util.registerListener)(t._el,"scroll",e,EVENT_OPTS)}}},{key:"enableBScroll",value:function(){console.debug("ScrollView, enableBScroll");var e=this._el.parentElement,t=this,l=t.ev,i=[];t._js=!0,l.isJsScroll=!0,t._el.parentElement.classList.add("js-scroll"),import("./bscroll.min.js").then(function(s){t._jsScrollInstance=new s(e,{bounce:!0,bindToWrapper:!0,probeType:3}),t._jsScrollInstance.on("scroll",function(e){function s(){t.isScrolling=!1,l.velocityY=l.velocityX=0,t.scrollEnd(l),t._endTmr=null}if(t._jsScrollInstance){if(l.timeStamp=(new Date).getTime(),l.scrollTop=-1*e.y>>0,l.scrollLeft=-1*e.x>>0,t.isScrolling||(t.isScrolling=!0,l.startY=l.scrollTop,l.startX=l.scrollLeft,l.velocityY=l.velocityX=0,l.deltaY=l.deltaX=0,i.length=0,t.scrollStart(l)),i.push(l.scrollTop,l.scrollLeft,l.timeStamp),i.length>3){l.deltaY=l.scrollTop-l.startY,l.deltaX=l.scrollLeft-l.startX;for(var o=i.length-1,n=o,r=l.timeStamp-100,c=o;c>0&&i[c]>r;c-=3)n=c;if(n!==o){var a=i[o]-i[n],h=i[n-2]-i[o-2],u=i[n-1]-i[o-1];if(l.velocityY=h/a*FRAME_MS,l.velocityX=u/a*FRAME_MS,t._jsScrollInstance.options.scrollY){var _=t._jsScrollInstance.directionY;l.directionY=0===_?h>0?"up":"down":_>0?"down":"up"}else{var d=t._jsScrollInstance.directionX;l.directionX=0===d?u>0?"left":"right":d>0?"right":"left"}}}window.clearTimeout(t._endTmr),t._endTmr=window.setTimeout(s,SCROLL_END_DEBOUNCE_MS),t.scroll(l)}})})}},{key:"getHeight",value:function(){return this._js?this._jsScrollInstance.scrollerHeight:this._el&&this._el.scrollHeight}},{key:"getWidth",value:function(){return this._js?this._jsScrollInstance.scrollerWidth:this._el&&this._el.scrollWidth}},{key:"getTop",value:function(){return this._js?-1*this._jsScrollInstance.y:this._el&&this._el.scrollTop}},{key:"getLeft",value:function(){return this._js?-1*this._jsScrollInstance.x:this._el&&this._el.scrollLeft}},{key:"setTop",value:function(e){this._el.scrollTop=e}},{key:"setLeft",value:function(e){this._el.scrollLeft=e}},{key:"stop",value:function(){this.isScrolling=!1}},{key:"destroy",value:function(){this.stop(),this._js?(this._jsScrollInstance.destroy(),this._jsScrollInstance=null):(this._endTmr&&window.clearTimeout(this._endTmr),this._lsn&&this._lsn(),this._lsn=null);var e=this.ev;e.contentElement=e.fixedElement=e.scrollElement=e.headerElement={},this._el=this.ev=e=null,this.scrollStart&&(this.scrollStart=function(e){}),this.scroll&&(this.scrollStart=function(e){}),this.scrollEnd&&(this.scrollStart=function(e){})}},{key:"scrollTo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,l=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300,s=arguments[3],o=this._el,n=void 0;if(void 0===s&&(n=new _promise2.default(function(e){s=e})),!o)return console.assert(o,"The method of scrollTo() need scrollElement!"),s(),n;if(this._js)this._jsScrollInstance.scrollTo(e,-1*t,i),this._scrollToEndTimer&&window.clearTimeout(this._scrollToEndTimer),this._scrollToEndTimer=window.setTimeout(function(){s(),l._scrollToEndTimer=null},i);else{if(i<32)return this.setTop(t),this.setLeft(e),s(),n;var r=o.scrollTop,c=o.scrollLeft,a=i/16+100,h=this.transform,u=void 0,_=void 0,d=0,f=!1,m=function n(){if(d++,!l._el||f||d>a)return l.isScrolling=!1,o.style[h]="",void s();_=(new Date).getTime();var m=Math.min(1,(_-u)/i),v=--m*m*m+1;r!==t&&l.setTop(v*(t-r)+r),c!==e&&l.setLeft(Math.floor(v*(e-c)+c)),v<1?window.requestAnimationFrame(n):(f=!0,l.isScrolling=!1,s())};this.isScrolling=!0,u=(new Date).getTime(),window.requestAnimationFrame(m)}return n}},{key:"scrollToTop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300;return this.scrollTo(0,0,e)}},{key:"scrollToBottom",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=0;return this._el&&(t=this._js?this.ev.scrollHeight-this._cel.clientHeight:this._el.scrollHeight-this._el.clientHeight),this.scrollTo(0,t,e)}},{key:"scrollBy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300,i=arguments[3];return t+=this.getTop(),e+=this.getLeft(),this.scrollTo(e,t,l,i)}},{key:"scrollToElement",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments[4];if(!e)return console.assert(e,"The method scrollToElement() need element!"),!1;var o=0,n=e.offsetTop;return(0,_util.isPresent)(l)&&((0,_util.isNumber)(l)&&0!==l&&(o=e.offsetLeft+l),(0,_util.isBoolean)(l)&&l&&(o=e.offsetLeft+(this.ev.contentWidth-e.offsetWidth)/2)),(0,_util.isPresent)(i)&&((0,_util.isNumber)(i)&&(n-=i),(0,_util.isBoolean)(i)&&i&&(n-=(this.ev.contentHeight-e.offsetHeight)/2)),this.scrollTo(o,n,t,s)}}]),e}();