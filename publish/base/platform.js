"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function getCss(t){var i,e={transform:null,transition:null,transitionDuration:null,transitionDelay:null,transitionTimingFn:null,transitionStart:null,transitionEnd:null,transformOrigin:null,animationDelay:null},n=["webkitTransform","-webkit-transform","webkit-transform","transform"];for(i=0;i<n.length;i++)if(void 0!==t.style[n[i]]){e.transform=n[i];break}for(n=["webkitTransition","transition"],i=0;i<n.length;i++)if(void 0!==t.style[n[i]]){e.transition=n[i];break}var r=e.transition.indexOf("webkit")>-1;return e.transitionDuration=(r?"-webkit-":"")+"transition-duration",e.transitionTimingFn=(r?"-webkit-":"")+"transition-timing-function",e.transitionDelay=(r?"-webkit-":"")+"transition-delay",e.transitionEnd=(r?"webkitTransitionEnd ":"")+"transitionend",e.transformOrigin=(r?"-webkit-":"")+"transform-origin",e.animationDelay=r?"webkitAnimationDelay":"animationDelay",e}function insertSuperset(t,i){var e=i.superset();if(e){var n=new PlatformNode(t,e);n.parent=i.parent,n.child=i,n.parent&&(n.parent.child=n),i.parent=n}}function setupPlatform(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(window.VM&&window.VM.platform)return window.VM.platform;var i=new Platform,e=_platformDefaultConfigs.PLATFORM_DEFAULT_CONFIGS;for(var n in t)if(e[n]&&(0,_util.isObject)(e[n])){var r=t[n],s=e[n];for(var a in r){var o={};o=(0,_util.defaults)(r[a],s[a]),s[a]=o}}else e[n]=t[n];return i.setDefault("mobile"),i.setPlatformConfigs(e),i.setQueryParams(new QueryParams),!i.navigatorPlatform()&&i.setNavigatorPlatform(window.navigator.platform),!i.userAgent()&&i.setUserAgent(window.navigator.userAgent),!i.lang()&&i.setLang("zh-cn",!0),!i.dir()&&i.setDir("ltr",!0),i.setCssProps(document.documentElement),i.init(),i.beforeReady(),window.VM=window.VM||{},window.VM.platform=i,i}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);exports.setupPlatform=setupPlatform;var _util=require("../util/util"),_platformDefaultConfigs=require("./platform-default-configs"),Platform=function(){function t(){var i=this;(0,_classCallCheck3.default)(this,t),this._readyPromise=new _promise2.default(function(t,e){i._readyResolve=t,i._readyReject=e}),this._versions={},this._dir=null,this._lang=null,this._qp=null,this._bPlt=null,this._ua=null,this._default=null,this._platforms=[],this._registry=null,this._pW=0,this._pH=0,this._lW=0,this._lH=0,this._isPortrait=null,this._nt=null,this._rm={},this.css={transform:null,transition:null,transitionDuration:null,transitionDelay:null,transitionTimingFn:null,transitionStart:null,transitionEnd:null,transformOrigin:null,animationDelay:null}}return(0,_createClass3.default)(t,[{key:"setCssProps",value:function(t){this.css=getCss(t)}},{key:"is",value:function(t){return this._platforms.indexOf(t)>-1}},{key:"platforms",value:function(){return this._platforms}},{key:"versions",value:function(){return this._versions}},{key:"version",value:function(){for(var t in this._versions)if(this._versions[t])return this._versions[t];return{}}},{key:"ready",value:function(){return this._readyPromise}},{key:"triggerReady",value:function(t){this._readyResolve(t)}},{key:"triggerFail",value:function(t){this._readyReject(t)}},{key:"beforeReady",value:function(){this.triggerReady("H5 Initialization Process!")}},{key:"setDir",value:function(t,i){this._dir=(t||"").toLowerCase(),i&&document.documentElement.setAttribute("dir",t)}},{key:"dir",value:function(){return this._dir}},{key:"isRTL",value:function(){return"rtl"===this._dir}},{key:"setLang",value:function(t,i){this._lang=t,i&&document.documentElement.setAttribute("lang",t)}},{key:"lang",value:function(){return this._lang}},{key:"setNetType",value:function(t){this._nt=t}},{key:"netType",value:function(){return this._nt}},{key:"registerMethod",value:function(t,i){if(!t)return this._rm;this._rm[t]&&console.warn("["+t+"] had been registered, please check the registerMethod() in platform-configs.js and the platform list is ["+this._platforms+"]"),this._rm[t]=i}},{key:"do",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._rm[t])return this._rm[t](i);console.warn("["+t+"] isn't registered, please check the registerMethod() in platform-configs.js and the platform list is ["+this._platforms+"]")}},{key:"setUserAgent",value:function(t){this._ua=t}},{key:"setQueryParams",value:function(t){this._qp=t}},{key:"getQueryParam",value:function(t){return this._qp.get(t)}},{key:"userAgent",value:function(){return this._ua||""}},{key:"setNavigatorPlatform",value:function(t){this._bPlt=t}},{key:"navigatorPlatform",value:function(){return this._bPlt||""}},{key:"width",value:function(){return this._calcDim(),this._isPortrait?this._pW:this._lW}},{key:"height",value:function(){return this._calcDim(),this._isPortrait?this._pH:this._lH}},{key:"isPortrait",value:function(){return this._calcDim(),this._isPortrait}},{key:"isLandscape",value:function(){return!this.isPortrait()}},{key:"_calcDim",value:function(){window.screen.width>0&&window.screen.height>0&&(window.innerWidth<window.innerHeight?(this._pW<=window.innerWidth&&(this._isPortrait=!0,this._pW=window.innerWidth),this._pH<=window.innerHeight&&(this._isPortrait=!0,this._pH=window.innerHeight)):(this._lW>window.innerWidth&&(this._isPortrait=!0),this._lW<=window.innerWidth&&(this._isPortrait=!1,this._lW=window.innerWidth),this._lH<=window.innerHeight&&(this._isPortrait=!1,this._lH=window.innerHeight)))}},{key:"setPlatformConfigs",value:function(t){this._registry=t||{}}},{key:"getPlatformConfig",value:function(t){return this._registry[t]||{}}},{key:"registry",value:function(){return this._registry}},{key:"setDefault",value:function(t){this._default=t}},{key:"testQuery",value:function(t,i){return t.toLowerCase().split(";").indexOf(i)>-1}},{key:"testNavigatorPlatform",value:function(t){return new RegExp(t,"i").test(this._bPlt)}},{key:"matchUserAgentVersion",value:function(t){if(this._ua&&t){var i=this._ua.match(t);if(i)return{major:i[1],minor:i[2],third:i[3]}}}},{key:"testUserAgent",value:function(t){return!!this._ua&&this._ua.indexOf(t)>=0}},{key:"isPlatformMatch",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=this._qp.get("platform");if(n)return this.testQuery(n,t);i=i||[t];for(var r=this._ua.toLowerCase(),s=0;s<i.length;s++)if(r.indexOf(i[s])>-1){for(var a=0;a<e.length;a++)if(r.indexOf(e[a])>-1)return!1;return!0}return!1}},{key:"init",value:function(){this._calcDim(),this._platforms=[];var t=void 0,i=void 0,e=void 0;for(var n in this._registry)(e=this.matchPlatform(n))&&(e.isEngine?i=e:(!t||e.depth>t.depth)&&(t=e));if(t||(t=new PlatformNode(this._registry,this._default)),t){i&&(i.child=t,t.parent=i,t=i);for(var r=t;r;)insertSuperset(this._registry,r),r=r.child;for(r=t.parent;r;)t=r,r=r.parent;for(r=t;r;)r.beforeInitialize(this),r.initialize(this),this._platforms.push(r.name),this._versions[r.name]=r.version(this),r=r.child}}},{key:"matchPlatform",value:function(t){var i=new PlatformNode(this._registry,t),e=i.getRoot(this);if(e){e.depth=0;for(var n=e.child;n;)e.depth++,n=n.child}return e}}]),t}(),PlatformNode=function(){function t(i,e){(0,_classCallCheck3.default)(this,t),this.parent=null,this.child=null,this.depth=null,this.registry=i,this.c=i[e],this.name=e,this.isEngine=this.c&&this.c.isEngine}return(0,_createClass3.default)(t,[{key:"settings",value:function(){return this.c.settings||{}}},{key:"superset",value:function(){return this.c.superset}},{key:"isMatch",value:function(t){return this.c.isMatch&&this.c.isMatch(t)}},{key:"beforeInitialize",value:function(t){this.c.beforeInitialize&&this.c.beforeInitialize(t)}},{key:"initialize",value:function(t){this.c.initialize&&this.c.initialize(t)}},{key:"version",value:function(t){if(this.c.versionParser){var i=this.c.versionParser(t);if(i){i.major||(i.major="0"),i.minor||(i.minor="0"),i.third||(i.third="0");var e=i.major+"."+i.minor+(i.third?"."+i.third:"");return{str:e,num:parseFloat(e),major:parseInt(i.major,10),minor:parseInt(i.minor,10),third:parseInt(i.third,10)}}}}},{key:"getRoot",value:function(i){if(this.isMatch(i)){var e=this.getSubsetParents(this.name);if(!e.length)return this;for(var n=null,r=null,s=0;s<e.length;s++)if(n=new t(this.registry,e[s]),n.child=this,r=n.getRoot(i))return this.parent=n,r}return null}},{key:"getSubsetParents",value:function(t){var i=[],e=null;for(var n in this.registry)e=this.registry[n],e.subsets&&e.subsets.indexOf(t)>-1&&i.push(n);return i}}]),t}(),QueryParams=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href;(0,_classCallCheck3.default)(this,t),this.data={},this.parseUrl(i)}return(0,_createClass3.default)(t,[{key:"get",value:function(t){return this.data[t.toLowerCase()]}},{key:"parseUrl",value:function(t){if(t){var i=t.indexOf("?");if(i>-1)for(var e=t.slice(i+1).split("&"),n=0;n<e.length;n++)if(e[n].indexOf("=")>0){var r=e[n].split("=");r.length>1&&(this.data[r[0].toLowerCase()]=r[1].split("#")[0])}}return this.data}}]),t}();